<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>Using Refit with the new System.Text.Json APIs | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Using Refit with the new System.Text.Json APIs in .NET Core 3.0 to boost performance"><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="aspnetcore,dotnet,refit"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2019-06-16T00:00:00Z"><meta property="article:modified_time" content="2019-06-16T00:00:00Z"><meta property="article:tag" content="aspnetcore,dotnet,refit"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Using Refit with the new System.Text.Json APIs in .NET Core 3.0 to boost performance"><meta property="og:image" content="https://cdn.martincostello.com/martin_small-v3.png"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="Using Refit with the new System.Text.Json APIs"><meta property="og:type" content="article"><meta property="og:updated_time" content="2019-06-16T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/using-refit-with-the-new-system.text.json-apis/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Using Refit with the new System.Text.Json APIs in .NET Core 3.0 to boost performance"><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/martin_small-v3.png"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="Using Refit with the new System.Text.Json APIs"><meta name=twitter:url content="https://blog.martincostello.com/using-refit-with-the-new-system.text.json-apis/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/using-refit-with-the-new-system.text.json-apis/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>Using Refit with the new System.Text.Json APIs</h1><p class="col-md-8 fs-4 lead">Using Refit with the new System.Text.Json APIs in .NET Core 3.0 to boost performance</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>16 June 2019 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>16 June 2019 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Using+Refit+with+the+new+System.Text.Json+APIs+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fusing-refit-with-the-new-system.text.json-apis%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><p>I&rsquo;m a big fan of the <a href=https://github.com/reactiveui/refit title="Refit on GitHub.com"><em>Refit</em></a> library for calling HTTP APIs from my .NET applications.</p><p>It uses code generation to let you do simple HTTP calls using interfaces and uses <a href=https://www.newtonsoft.com/json title="JSON.NET website">JSON.NET</a> under-the-hood to handle serializing and deserializing JSON.</p><p>For example, to get a repository from the GitHub API you could define these types:</p><pre tabindex=0><code>public class Organization
{
    [JsonProperty(&#34;login&#34;)]
    public string Login { get; set; }

    [JsonProperty(&#34;id&#34;)]
    public long Id { get; set; }

    // ... other properties
}

[Headers(&#34;Accept: application/vnd.github.v3+json&#34;, &#34;User-Agent: My-App/1.0.0&#34;)]
public interface IGitHub
{
    [Get(&#34;/orgs/{organization}&#34;)]
    Task&lt;Organization&gt; GetOrganizationAsync(string organization);
}
</code></pre><p>Then you could call the API like this:</p><pre tabindex=0><code>var client = RestService.For&lt;IGitHub&gt;(&#34;https://api.github.com&#34;);
var org = await client.GetOrganizationAsync(&#34;dotnet&#34;);
</code></pre><p>This week <a href=https://devblogs.microsoft.com/dotnet/announcing-net-core-3-0-preview-6/ title="Announcing .NET Core 3.0 Preview 6">.NET Core 3.0 preview 6</a> was released, and with that the <a href=https://devblogs.microsoft.com/dotnet/try-the-new-system-text-json-apis/ title="Try the new System.Text.Json APIs">new System.Text.Json APIs</a>. These new APIs are designed to be more performant and do less allocations that JSON.NET, so should bring performance benefits to applications that use them.</p><p>So what should you do if you want to use the new System.Text.Json APIs with Refit?</p><p>READMORE</p><p>Refit has some extension points to let you change how things work, including JSON (de)serialization. This means we can just provide our own <code>IContentSerializer</code> implementation to the <code>RefitSettings</code> class to replace JSON.NET with the new JSON APIs.</p><p>Here&rsquo;s the equivalent code to the above to create an <code>IGitHub</code> instance with the new serializer. The complete code for the <code>SystemTextJsonContentSerializer</code> class is at the bottom of this post.</p><pre tabindex=0><code>var options = new JsonSerializerOptions()
{
    PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
    WriteIndented = true,
};

var settings = new RefitSettings()
{
    ContentSerializer = new SystemTextJsonContentSerializer(options)
};

var client = RestService.For&lt;IGitHub&gt;(&#34;https://api.github.com&#34;, settings);
</code></pre><p>You&rsquo;ll also need to update your objects if you use attributes to control the serialization of the property names, for example the <code>Organization</code> object defined above becomes the following, with <code>[JsonProperty("...")]</code> replaced with <code>[JsonPropertyName("...")]</code> from the <code>System.Text.Json.Serialization</code> namespace.</p><pre tabindex=0><code>using System.Text.Json.Serialization;

public class Organization
{
    [JsonPropertyName(&#34;login&#34;)]
    public string Login { get; set; }

    [JsonPropertyName(&#34;id&#34;)]
    public long Id { get; set; }

    // ... other properties
}
</code></pre><p>I decided to put together some simple benchmarks with <a href=https://github.com/dotnet/BenchmarkDotNet title="BenchmarkDotNet on GitHub.com">BenchmarkDotNet</a> to compare the two implementations. If you want to run them yourself you can find the repo here: <a href=https://github.com/martincostello/Refit-Json-Benchmarks title="Refit-Json-Benchmarks on GitHub.com">https://github.com/martincostello/Refit-Json-Benchmarks</a></p><p>There&rsquo;s three benchmarks that try out reading an object, reading a collection and writing an object using both JSON.NET and System.Text.Json using a stubbed-out <code>HttpClient</code> to the GitHub API.</p><h2 id=_so-how-much-faster-is-it_><em>So how much faster is it?</em></h2><p>The results are fairly impressive on my laptop running Windows 10 (<a href=https://github.com/martincostello/Refit-Json-Benchmarks#results title="Benchmark results">full results</a>):</p><table><thead><tr><td><strong>Benchmark</strong></td><td><strong>Mean</strong></td><td><strong>Ratio</strong></td><td><strong>Allocated</strong></td></tr></thead><tbody><tr><td>Read_Collection_NewtonsoftJson</td><td>2.366 ms</td><td>1.00</td><td>297.95 KB</td></tr><tr><td>Read_Collection_SystemTextJson</td><td>1.404 ms</td><td>0.55</td><td>270.18 KB</td></tr><tr><td>Read_Object_NewtonsoftJson</td><td>219.60 μs</td><td>1.00</td><td>14.15 KB</td></tr><tr><td>Read_Object_SystemTextJson</td><td>29.42 μs</td><td>0.13</td><td>6.49 KB</td></tr><tr><td>Write_Object_NewtonsoftJson</td><td>22.79 μs</td><td>1.00</td><td>8.09 KB</td></tr><tr><td>Write_Object_SystemTextJson</td><td>16.23 μs</td><td>0.71</td><td>6.13 KB</td></tr></tbody></table><hr><p>For these specific example requests and responses, for reading an object <strong>the mean time per operation is reduced by 87%</strong> and the amount of <strong>memory allocated reduced by 55%</strong>!</p><p>If you use Refit heavily in an existing .NET Core application to consume JSON it looks like there&rsquo;s a lot of performance gain to be had by switching from JSON.NET to the new System.Text.Json APIs in .NET Core 3.0!</p><h2 id=links>Links</h2><ul><li><a href=https://github.com/reactiveui/refit>Refit</a></li><li><a href=https://www.newtonsoft.com/json>JSON.NET</a></li><li><a href=https://devblogs.microsoft.com/dotnet/try-the-new-system-text-json-apis/><em>Try the new System.Text.Json APIs</em></a></li><li><a href=https://devblogs.microsoft.com/dotnet/announcing-net-core-3-0-preview-6/><em>Announcing .NET Core 3.0 Preview 6</em></a></li><li><a href=https://github.com/martincostello/Refit-Json-Benchmarks>Refit Benchmarks with System.Text.Json</a></li></ul><h2 id=systemtextjsoncontentserializer-code><code>SystemTextJsonContentSerializer</code> Code</h2><pre tabindex=0><code>using System;
using System.IO;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Text.Json.Serialization;
using System.Threading.Tasks;
using Refit;

namespace RefitWithSystemTextJson;

public sealed class SystemTextJsonContentSerializer : IContentSerializer
{
    private static readonly MediaTypeHeaderValue _jsonMediaType =
        new MediaTypeHeaderValue(&#34;application/json&#34;) { CharSet = Encoding.UTF8.WebName };

    public SystemTextJsonContentSerializer(JsonSerializerOptions serializerOptions)
    {
        SerializerOptions = serializerOptions;
    }

    private JsonSerializerOptions SerializerOptions { get; }

    public async Task&lt;T&gt; DeserializeAsync&lt;T&gt;(HttpContent content)
    {
        using var utf8Json = await content.ReadAsStreamAsync();
        return await JsonSerializer.ReadAsync&lt;T&gt;(utf8Json, SerializerOptions);
    }

    public async Task&lt;HttpContent&gt; SerializeAsync&lt;T&gt;(T item)
    {
        var stream = new MemoryStream();

        try
        {
            await JsonSerializer.WriteAsync(item, stream, SerializerOptions);
            await stream.FlushAsync();

            var content = new StreamContent(stream);

            content.Headers.ContentType = _jsonMediaType;

            return content;
        }
        catch (Exception)
        {
            await stream.DisposeAsync();
            throw;
        }
    }
}
</code></pre><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Using+Refit+with+the+new+System.Text.Json+APIs+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fusing-refit-with-the-new-system.text.json-apis%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/main rel=noopener title="View commit main on GitHub">main</a> on <a href=https://github.com/martincostello/blog/tree/main rel=noopener title="View branch main on GitHub">main</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>