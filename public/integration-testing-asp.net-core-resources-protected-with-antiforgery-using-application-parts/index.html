<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Using ASP.NET Core Application Parts to simplify testing of HTTP resources that are protected by antiforgery features."><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="aspnet,aspnetcore,antiforgery,csrf,dotnet,testing,xsrf"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2020-06-16T00:00:00Z"><meta property="article:modified_time" content="2020-06-16T00:00:00Z"><meta property="article:tag" content="aspnet,aspnetcore,antiforgery,csrf,dotnet,testing,xsrf"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Using ASP.NET Core Application Parts to simplify testing of HTTP resources that are protected by antiforgery features."><meta property="og:image" content="https://cdn.martincostello.com/martin_small-v3.png"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts"><meta property="og:type" content="article"><meta property="og:updated_time" content="2020-06-16T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/integration-testing-asp.net-core-resources-protected-with-antiforgery-using-application-parts/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Using ASP.NET Core Application Parts to simplify testing of HTTP resources that are protected by antiforgery features."><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/martin_small-v3.png"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts"><meta name=twitter:url content="https://blog.martincostello.com/integration-testing-asp.net-core-resources-protected-with-antiforgery-using-application-parts/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/integration-testing-asp.net-core-resources-protected-with-antiforgery-using-application-parts/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts</h1><p class="col-md-8 fs-4 lead">Using ASP.NET Core Application Parts to simplify testing of HTTP resources that are protected by antiforgery features.</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>16 June 2020 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>16 June 2020 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Integration+Testing+ASP.NET+Core+Resources+Protected+with+Antiforgery+Using+Application+Parts+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fintegration-testing-asp.net-core-resources-protected-with-antiforgery-using-application-parts%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><p>To protect your POST resources in an ASP.NET Core application from <a href=https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery title="Prevent Cross-Site Request Forgery (XSRF/CSRF) attacks in ASP.NET Core">Cross-Site Request Forgery</a> (CSRF) an application developer would typically use the <a href=https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery#aspnet-core-antiforgery-configuration title="ASP.NET Core antiforgery configuration">antiforgery</a> features to require an antiforgery token and cookie are included in HTTP POST form requests.</p><p>A necessary downside of these protections is that they make it harder to integration test such resources, particularly in a headless manner. This is because the tests need to acquire the antiforgery token and cookie to be able to successfully pass the antiforgery protections on a resource that needs to be tested.</p><p>A typical approach for this is to scrape the HTML response from the application for the hidden form field token (often named <code>__RequestVerificationToken</code>) using Regular Expressions and then using that, along with the cookie, in the request(s) the test(s) make. This can however make tests brittle to change, particularly if the UI is refactored.</p><p>In this blog post I&rsquo;ll discuss an alternate approach using <a href=https://docs.microsoft.com/en-us/aspnet/core/mvc/advanced/app-parts title="Share controllers, views, Razor Pages and more with Application Parts">ASP.NET Core Application Parts</a> that can make such tests easier to author and maintain, allowing you to concentrate on the core logic of your tests, rather than boilerplate setup.</p><p>READMORE</p><h2 id=motivation>Motivation</h2><p>I&rsquo;ve recently been reimplementing part of a .NET Framework web application over to a newer ASP.NET Core 3.1 web application. The part of the application in question requires a write operation, so uses an HTML form for the request to be made by the user so that it is safe from CSRF attacks.</p><p>The operation can have various different responses, so there&rsquo;s many different cases to cover as part of automated integration testing. I&rsquo;ve blogged about <a href=https://blog.martincostello.com/reliably-testing-http-integrations-in-dotnet-applications/ title="Reliably Testing HTTP Integrations in a .NET Application">HTTP integration testing before</a> and using <a href=https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests title="Integration tests in ASP.NET Core"><code>WebApplicationFactory&lt;T></code></a>, but the need to pass the antiforgery protections presented a bit of a challenge.</p><p>One approach I&rsquo;ve used in the past is to add <em>&ldquo;test-only&rdquo;</em> controller methods to the application, but then care has to be taken to ensure that these can&rsquo;t be used in production to bypass security features. It also bloats the code of the service itself, having to be deployed with code that isn&rsquo;t actually used.</p><p>It occurred to me that a better way to manage this would be instead to use Application Parts to inject the test resources into the application at runtime as part of the tests. This allows us to add helper features to the application for use with the integration tests, while keeping the production code itself clean and uncluttered by additional test infrastructure and code paths.</p><p>While I can&rsquo;t share the code for the application itself, I have put a sample application together that shows the approach in action for both web forms and JSON endpoints for HTTP POST and DELETE operations up on GitHub: <a href=https://github.com/martincostello/antiforgery-testing-application-part title="antiforgery-testing-application-part on GitHub.com">https://github.com/martincostello/antiforgery-testing-application-part</a></p><h2 id=how-it-works>How It Works</h2><p>The sample application is just a simple TODO list application that gives us something to demonstrate the approach against, but the concepts should work for any type of ASP.NET Core application using antiforgery features.</p><p>The test project contains an <a href=https://github.com/martincostello/antiforgery-testing-application-part/blob/5d8ed60e8874dc8403bb43a404a5a540362e5d07/tests/TodoApp.Tests/AntiforgeryTokenController.cs#L16 title="AntiforgeryTokenController class"><code>AntiforgeryTokenController</code></a> class. This contains an <a href=https://github.com/martincostello/antiforgery-testing-application-part/blob/f8985fe1bbaa800cf73bc62bb85949c1c0a8a698/tests/TodoApp.Tests/AntiforgeryTokenController.cs#L39-L65 title="GET action to get valid CSRF tokens">HTTP GET resource</a> that uses the antiforgery features to return a JSON payload containing valid CSRF tokens and the relevant cookie/form/header names to use to validate requests:</p><pre tabindex=0><code>public IActionResult GetAntiforgeryTokens(
    [FromServices] IAntiforgery antiforgery,
    [FromServices] IOptions&lt;AntiforgeryOptions&gt; options)
{
    AntiforgeryTokenSet tokens = antiforgery.GetTokens(HttpContext);

    var model = new AntiforgeryTokens()
    {
        CookieName = options.Value.Cookie.Name,
        CookieValue = tokens.CookieToken,
        FormFieldName = options.Value.FormFieldName,
        HeaderName = tokens.HeaderName,
        RequestToken = tokens.RequestToken,
    };

    return Json(model);
}
</code></pre><p>This is then configured as an Application Part by the <a href=https://github.com/martincostello/antiforgery-testing-application-part/blob/f8985fe1bbaa800cf73bc62bb85949c1c0a8a698/tests/TodoApp.Tests/IWebHostBuilderExtensions.cs#L26-L39 title="ConfigureAntiforgeryTokenResource method"><code>ConfigureAntiforgeryTokenResource()</code></a> method, which is <a href=https://github.com/martincostello/antiforgery-testing-application-part/blob/f8985fe1bbaa800cf73bc62bb85949c1c0a8a698/tests/TodoApp.Tests/TestServerFixture.cs#L82 title="TestServer registration">registered with the test server fixture</a>:</p><pre tabindex=0><code>protected override void ConfigureWebHost(IWebHostBuilder builder)
{
    builder.ConfigureAntiforgeryTokenResource();
}
</code></pre><p>One potential gotcha to watch out for is to make sure that requests to the test controller don&rsquo;t return an HTTP 404. To fix this, make sure that the assembly containing the test controllers is decorated with the <a href=https://github.com/martincostello/antiforgery-testing-application-part/blob/5d8ed60e8874dc8403bb43a404a5a540362e5d07/tests/TodoApp.Tests/TodoApp.Tests.csproj#L24-L31 title="Adding the ApplicationPart attribute"><code>[ApplicationPart]</code> attribute</a>. One way you can achieve this is with adding a snippet like the below to your test project&rsquo;s <code>.csproj</code> file:</p><pre tabindex=0><code>&lt;!--
  Add [ApplicationPart(&#34;TodoApp.Tests&#34;)] to the assembly so the controller is discovered.
--&gt;
&lt;ItemGroup&gt;
  &lt;AssemblyAttribute Include=&#34;Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute&#34;&gt;
    &lt;_Parameter1&gt;TodoApp.Tests&lt;/_Parameter1&gt;
  &lt;/AssemblyAttribute&gt;
&lt;/ItemGroup&gt;
</code></pre><p>Thanks to <a href=https://andrewlock.net/when-asp-net-core-cant-find-your-controller-debugging-application-parts/#what-are-application-parts- title="When ASP.NET Core can't find your controller: debugging application parts">Andrew Lock&rsquo;s blog post on Application Parts</a> for pointing me to towards the fix.</p><p>This then allows tests to use the <a href=https://github.com/martincostello/antiforgery-testing-application-part/blob/f8985fe1bbaa800cf73bc62bb85949c1c0a8a698/tests/TodoApp.Tests/TestServerFixture.cs#L52-L64 title="GetAntiforgeryTokensAsync method"><code>GetAntiforgeryTokensAsync()</code></a> helper method to perform an HTTP GET to the application to obtain valid CSRF tokens to use:</p><pre tabindex=0><code>public async Task&lt;AntiforgeryTokens&gt; GetAntiforgeryTokensAsync()
{
    using var httpClient = CreateClient();
    using var response = await httpClient.GetAsync(AntiforgeryTokenController.GetTokensUri);

    return JsonSerializer.Deserialize&lt;AntiforgeryTokens&gt;(await response.Content.ReadAsStringAsync());
}
</code></pre><p>The tests then use this to configure an <code>HttpClient</code> with CSRF tokens so that HTTP POST/DELETE etc. requests to the application pass the checks by the antiforgery protections.</p><pre tabindex=0><code>[Fact]
public async Task Can_Create_Todo_Item_With_Html_Form()
{
    // Arrange - Get valid CSRF tokens and parameter names from the server
    AntiforgeryTokens tokens = await Fixture.GetAntiforgeryTokensAsync();

    // Configure a handler with the CSRF cookie
    using var cookieHandler = new CookieContainerHandler();
    cookieHandler.Container.Add(
        Fixture.Server.BaseAddress,
        new Cookie(tokens.CookieName, tokens.CookieValue));

    // Create an HTTP client and add the CSRF cookie
    using var httpClient = Fixture.CreateDefaultClient(cookieHandler);

    // Create form content to create a new item with the CSRF parameter added
    var form = new Dictionary&lt;string, string&gt;()
    {
        [tokens.FormFieldName] = tokens.RequestToken,
        [&#34;text&#34;] = &#34;Buy milk&#34;,
    };

    // Act - Create a new list item
    using var content = new FormUrlEncodedContent(form);
    using var response = await httpClient.PostAsync(&#34;home/additem&#34;, content);

    // Assert - The item was created
    response.StatusCode.ShouldBe(HttpStatusCode.Redirect);
}
</code></pre><p>With these building blocks in place, it&rsquo;s then quite easy to iterate on to add test cases for all of the relevant endpoints and get good code coverage for all the different scenarios.</p><h2 id=conclusion>Conclusion</h2><p>I&rsquo;ve found this approach quite a neat solution to being able to test resources with antiforgery protections, so I figured I&rsquo;d share the approach with the wider .NET community.</p><p>Using a variant of this approach allowed me to quickly add a variety of test cases for the feature I was working on migrating to ensure it was robust and well-tested, giving much more confidence in the work. At the same time, it removed the need to have brittle HTML scraping code, or even the need to have a UI for the back-end written at all before being able to start integration testing.</p><p>I hope you&rsquo;ve found this post interesting and useful - happy coding!</p><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Integration+Testing+ASP.NET+Core+Resources+Protected+with+Antiforgery+Using+Application+Parts+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fintegration-testing-asp.net-core-resources-protected-with-antiforgery-using-application-parts%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/1e081eee55dfb7b252dce3b0ab73a36513d14253 rel=noopener title="View commit 1e081eee55dfb7b252dce3b0ab73a36513d14253 on GitHub">1e081ee</a> on <a href=https://github.com/martincostello/blog/tree/copilot/fix-244 rel=noopener title="View branch copilot/fix-244 on GitHub">copilot/fix-244</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>