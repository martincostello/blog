<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>Improving ASP.NET Core Before It Ships üö¢ | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Upgrading to ASP.NET Core 2.1 can deliver serious performance improvements to your web applications as well as make you much more productive as a developer."><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="dotnet,aspnetcore,performance"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2022-05-03T00:00:00Z"><meta property="article:modified_time" content="2022-05-03T00:00:00Z"><meta property="article:tag" content="dotnet,aspnetcore,performance"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Upgrading to ASP.NET Core 2.1 can deliver serious performance improvements to your web applications as well as make you much more productive as a developer."><meta property="og:image" content="https://cdn.martincostello.com/blog_deadlock-parallel-stacks.webp"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="Improving ASP.NET Core Before It Ships üö¢"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-05-03T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/improving-asp.net-core-before-it-ships/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Upgrading to ASP.NET Core 2.1 can deliver serious performance improvements to your web applications as well as make you much more productive as a developer."><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/blog_deadlock-parallel-stacks.webp"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="Improving ASP.NET Core Before It Ships üö¢"><meta name=twitter:url content="https://blog.martincostello.com/improving-asp.net-core-before-it-ships/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/improving-asp.net-core-before-it-ships/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>Improving ASP.NET Core Before It Ships üö¢</h1><p class="col-md-8 fs-4 lead">Upgrading to ASP.NET Core 2.1 can deliver serious performance improvements to your web applications as well as make you much more productive as a developer.</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>3 May 2022 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>3 May 2022 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Improving+ASP.NET+Core+Before+It+Ships+%F0%9F%9A%A2+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fimproving-asp.net-core-before-it-ships%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><blockquote><p><em>This blog post was originally published by me on the <a href=https://medium.com/justeattakeaway-tech/improving-asp-net-core-before-it-ships-3e44b6f65054>Just Eat Tech blog</a>.</em></p></blockquote><p>Writing code that millions of people will use is something we do every day. Writing code that millions
of developers will use feels a little different.</p><p>Have you ever wondered why Microsoft releases preview versions of their products before the final release?
Well, it‚Äôs so real customers can help ensure their quality before they go live. In this post, we‚Äôll tell you
about an issue we found in testing the previews of ASP.NET Core and how we worked with Microsoft to fix it.</p><p>READMORE</p><h2 id=early-adoption-and-release-candidates->Early-Adoption and Release Candidates üåÖüê£</h2><p>We‚Äôre big fans of open-source software, and like to give back to the community wherever we can. For the past
few years, we‚Äôve tested upcoming features of new .NET releases with the previews. This lets us experiment with
new features and provide feedback to the .NET team. It also helps verify new features with our use cases, and
adds an example of real-world code to help catch bugs.</p><p><a href=https://learn.microsoft.com/aspnet/core/fundamentals/minimal-apis><em>ASP.NET Core Minimal APIs</em></a>, new in .NET 6, provide a simpler application model compared to
<a href=https://learn.microsoft.com/aspnet/core/mvc/overview>ASP.NET Core MVC</a>. It looked interesting for simplifying some of our API applications. We tested it with
some APIs in our dev environments and got great results using less code. We also found several issues with the
previews which got fixed, and we even got to <a href=https://devblogs.microsoft.com/dotnet/asp-net-core-updates-in-net-6-preview-7/#support-request-response-and-user-for-minimal-actions>implement a feature</a>.</p><p>Microsoft supports preview versions when they become Release Candidates. Once <a href=https://devblogs.microsoft.com/dotnet/announcing-net-6-release-candidate-1/>.NET 6 RC1</a>
landed we started to roll out the changes to production where it would serve traffic from our customers.</p><p>We use <a href=https://martinfowler.com/bliki/CanaryRelease.html><em>Canary Releases</em></a> as part of our continuous deployment strategy. This lets us incrementally roll
out changes, reducing the risks from software change. If anything goes wrong, we can roll back to the last version
of an application within a few minutes. We started with one application and deployed it on a Monday (the day we see
the least production traffic). We left it in <a href=https://martinfowler.com/bliki/CanaryRelease.html><em>&ldquo;canary&rdquo;</em></a> üê§ for a 24-hour period for 25% of our production
traffic. After promoting to 100% of traffic the next day, we repeated this with some other applications. Within a
week we were running some EC2 and Lambda workloads on .NET 6 RC1.</p><p>Our deployments were fine so when <a href=https://devblogs.microsoft.com/dotnet/announcing-net-6-release-candidate-2/>.NET 6 RC2</a> was announced we updated and increased the rollout
to more apps. Once again, everything went fine with no problems. We were ready to update to the final .NET 6
release in November.</p><h2 id=deadlock->Deadlock! üíÄüîí</h2><p>The <a href=https://devblogs.microsoft.com/dotnet/announcing-net-6/>stable release of .NET 6</a> was out in November 2021. We updated our applications running the
release candidate to the stable release. Everything was fine, with no issues. The job was done, or so it seemed.</p><p>Over lunchtime a few hours later, one of our updated applications using Minimal APIs ground to a halt. Our alerting
system fired up and paged the on-call engineer for the application. Clients of the application were getting HTTP
request timeouts and HTTP 503 errors. Looking at the AWS Auto Scaling Group for the app showed that there appeared
to be no healthy instances. This seemed like a classic case of an application <a href=https://en.wikipedia.org/wiki/Deadlock_(computer_science)>deadlock</a>.</p><p><img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_deadlock-request-rate.webp alt="HTTP requests to the application when the deadlock occurred." title="HTTP requests to the application when the deadlock occurred."></p><p>We deployed the changes hours ago and had no issues with previews and all our tests had passed ‚Äî what had gone wrong?
ü§î The app self-healed within 20 minutes, we rolled back to the old version and started to look into it.</p><h2 id=replicating-the-issue->Replicating the Issue üîÅ</h2><p>The first step in diagnosing the root cause was to diff the code between the two releases. The only changes between
the two versions were to update the .NET 6 NuGet package versions (e.g. <code>6.0.0-rc.2.21480.5</code> to <code>6.0.0</code>). This meant
that the root cause must be from a change in .NET between Release Candidate 2 and the stable release.</p><p>The clue that pointed us to where to look further for the problem was from our metrics. They showed that the application
reloaded its configuration right before the alerts fired.</p><p>We use <a href=https://developer.hashicorp.com/consul>Hashicorp Consul</a> to store configuration that we wish to change at runtime. This lets us change things
like feature toggles without needing to deploy a code change. Settings change either in the code within Git for a
permanent change, or in the Consul UI for a temporary change. Configuration resets to what is in the code every day at
0800, so temporary changes are reverted the following day.</p><p>When config changes in Consul, an agent installed on each EC2 instance gets notified. The agent makes an HTTP request
to the app installed on it to an endpoint we use to reload the config. In the case of our .NET apps, we use the
<a href=https://learn.microsoft.com/dotnet/api/microsoft.extensions.configuration.iconfigurationroot.reload><code>IConfigurationRoot.Reload()</code></a> method to do this, similar to what is shown below:</p><pre tabindex=0><code>app.MapPost(&#34;/configuration/reload&#34;, (IConfiguration config) =&gt;
{
    if (config is IConfigurationRoot root)
    {
        root.Reload();
    }
    return Results.NoContent();
});
</code></pre><p>Our configuration splits into <em>environment</em> settings and <em>application</em> settings. In this case, another team had changed
an <em>environment</em> setting which made the shared config reload. The <em>application</em> config hadn‚Äôt changed, so there wasn‚Äôt
an obvious cause-and-effect from the config change to the incident.</p><p>This gave us the hypothesis that when the application‚Äôs config reloads under high load it would go into a deadlock.</p><p>With this hypothesis, the next step was to try and replicate the issue. We turned to our staging environment, which is an
AWS environment that is as close to our production AWS environment as possible. All changes must pass through Staging
before they roll out into production.</p><p>Staging also has <em>&ldquo;synthetic load&rdquo;</em> running against it. This is artificial user traffic that is always running against
our apps and infrastructure deployed there.</p><p>We re-deployed the version of the application with the issue to our staging environment (with synthetic load running).
We then wrote a small shell script that called the config reload endpoint in a loop to see what would happen. Within
15 minutes the script reloading the config ground to a halt and then started timing out. Success, we had replicated
the problem!</p><h2 id=diagnosing-the-problem->Diagnosing the Problem üïµÔ∏è</h2><p>The next step was to get a better understanding of exactly what was causing the deadlock. With the app still running
(but deadlocked) in Staging, we used <a href=https://learn.microsoft.com/sysinternals/downloads/process-explorer><em>Process Explorer</em></a> to capture a memory dump of the process
which hosts the app. Once we had a memory dump we could use <a href=https://learn.microsoft.com/visualstudio/debugger/using-dump-files>Visual Studio to debug it</a>.</p><p>Opening the memory dump in Visual Studio with <a href=https://learn.microsoft.com/visualstudio/debugger/just-my-code><em>Just My Code</em></a> disabled lets see the state of the
application via the <a href=https://learn.microsoft.com/visualstudio/debugger/using-the-parallel-stacks-window><em>Parallel Stacks</em></a> window. The problem was easy to spot ‚Äî the graph of the
stacks showed that one stack was waiting on another stack and vice-versa (there were even some helpful üõë icons).</p><p>Threads for user requests were waiting on a lock held by reloading the config. The thread reloading the config was
waiting on a lock held by those user requests. Here was our deadlock!</p><p><img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_deadlock-parallel-stacks.webp alt="The parallel stacks in the deadlocked application." title="The parallel stacks in the deadlocked application."></p><h2 id=getting-the-bug-fixed->Getting the Bug Fixed üêõüîß</h2><p>Having determined that this deadlock was within .NET itself, we‚Äôd need to create an issue in the relevant
<a href=https://github.com/dotnet/runtime>dotnet GitHub repo</a>. Bugs are always easier to fix when you have a
<a href=https://en.wikipedia.org/wiki/Minimal_reproducible_example><em>Minimal Reproducible Example</em></a>, so we needed to provide one.</p><p>We created a self-contained GitHub repo that would <a href=https://github.com/martincostello/ConfigurationManagerDeadlock#readme>reproduce the bug</a> we had encountered and then
<a href=https://github.com/dotnet/runtime/issues/61747>opened an issue</a> for the .NET team to look into. The .NET engineer assigned to the issue, <a href=https://github.com/halter73>Stephen Halter</a>
from the ASP.NET Core team, was very helpful in getting to the bottom of the problem and <a href=https://github.com/dotnet/runtime/pull/63816>fixing it</a>.
We were also given a <a href=https://github.com/dotnet/runtime/issues/61747#issuecomment-973164180>work-around</a> so we could <em>fix-forward</em> and re-deploy the stable .NET 6.0 release.</p><p>The fix wasn‚Äôt trivial, so there was a lot of caution and due diligence on the part of the .NET team in
validating it. Not only did they need to check to make sure it had fixed the bug, but also that it did not
introduce any new issues. We helped by validating the fix in Staging using a nightly build of ASP.NET Core
that contained the fix before it merged to the <code>release/6.0</code> branch. We ran the same tests and we could no
longer replicate the original problem, nor had any new issues. üéâ</p><p>The fix was available as part of the <a href=https://github.com/dotnet/core/blob/main/release-notes/6.0/6.0.3/6.0.3.md>.NET 6.0.3</a> servicing release in March 2022. After
upgrading the apps to the new version, we were able to remove the workaround and tidy up our code. Now
we‚Äôre running ASP.NET Core 6 Minimal APIs in production apps at scale (over 45,000 requests/minute at peak)
with no issues and less boilerplate. üñ•Ô∏èüöÄ</p><h2 id=key-takeaways->Key Takeaways üîëü•°</h2><p>This blog post is a short tale of some of our adventures using previews of open-source software at scale in
production. Here are a few key points to take away from this post:</p><ul><li>A healthy open source software community includes publishers and consumers that collaborate. If you consume open source software, particularly for free, consider if there are ways you can contribute back. This might be in the form of feature requests, filling bugs, or contributing code changes. Working together in public makes open source software better for everyone who uses it.</li><li>Observability of applications is as important as their functionality ‚Äî if something goes wrong they can help you get back to a good state. They can also give you vital clues and insights into how to prevent it from happening again.</li><li>Keep your deployable units small. Practicing <a href=https://continuousdelivery.com/>continuous delivery</a> makes it easier to get to the root of a problem when something goes wrong.</li><li>Know your debugging tools and how you can leverage them in production. Knowing the tools at your disposal to use with production code as much as with local development pays dividends. Having a range of tools you are familiar with that you can bring to an incident can get you to a root cause faster.</li><li>Developers love minimal reproducible examples! When logging a bug you can help get it triaged sooner by giving an isolated sample for the maintainers to look at. This will then help the project develop a fix and make it available in a shorter period than a vague bug report might.</li></ul><p>We hope this post inspires you to try out the latest releases of your own favourite open-source software projects.
How about trying out the latest <a href=https://devblogs.microsoft.com/dotnet/announcing-dotnet-7-preview-3/>.NET 7 preview release</a> with one of your own .NET applications?</p><p>Happy coding!</p><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Improving+ASP.NET+Core+Before+It+Ships+%F0%9F%9A%A2+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fimproving-asp.net-core-before-it-ships%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/main rel=noopener title="View commit main on GitHub">main</a> on <a href=https://github.com/martincostello/blog/tree/main rel=noopener title="View branch main on GitHub">main</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>