<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>Migrating to Amazon S3 | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Migrating a static website from being hosted with IIS in Azure to S3, CloudFront and Lambda@Edge in AWS."><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="aws,cloudfront,lambda,lambda@edge,s3"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2017-08-28T00:00:00Z"><meta property="article:modified_time" content="2017-08-28T00:00:00Z"><meta property="article:tag" content="aws,cloudfront,lambda,lambda@edge,s3"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Migrating a static website from being hosted with IIS in Azure to S3, CloudFront and Lambda@Edge in AWS."><meta property="og:image" content="https://cdn.martincostello.com/blog_amazon-simple-storage-service.png"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="Migrating to Amazon S3"><meta property="og:type" content="article"><meta property="og:updated_time" content="2017-08-28T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/migrating-to-amazon-s3/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Migrating a static website from being hosted with IIS in Azure to S3, CloudFront and Lambda@Edge in AWS."><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/blog_amazon-simple-storage-service.png"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="Migrating to Amazon S3"><meta name=twitter:url content="https://blog.martincostello.com/migrating-to-amazon-s3/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/migrating-to-amazon-s3/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>Migrating to Amazon S3</h1><p class="col-md-8 fs-4 lead">Migrating a static website from being hosted with IIS in Azure to S3, CloudFront and Lambda@Edge in AWS.</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>28 August 2017 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>28 August 2017 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Migrating+to+Amazon+S3+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fmigrating-to-amazon-s3%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><p>Since I set up my blog in March 2014, it&rsquo;s been running in IIS as part of an Azure App Service. Initially this was required as the blog was originally a WordPress site, so a server was required to run the PHP code for WordPress. However when I got fed up with keeping WordPress up-to-date and <a href=/why-i-switched-from-wordpress-to-middleman/ title="Why I Switched From WordPress To Middleman">migrated to a static Middleman site</a>, I left it hosted in Azure. This was mainly because it was the easiest option, as that&rsquo;s where it was already, but also because this allowed me to specify HTTP response headers still, such as for <code>X-Frame-Options</code>.</p><p>At the end of the day though, this blog is still statically generated, and running a whole web server (actually two, one in Azure&rsquo;s East US datacentre, another in UK South) is just overkill. Given that Amazon S3 supports static website hosting, I thought I&rsquo;d migrate it to an S3 bucket instead.</p><p>READMORE</p><h2 id=the-starting-point>The Starting Point</h2><p>Things were already in a fairly good starting point for the migration. The code is all in <a href=https://github.com/martincostello/blog title="Blog source code on GitHub">GitHub</a>, there is already a Continuous Integration set up in <a href=https://travis-ci.org/martincostello/blog title="Travis CI build">Travis CI</a>, and I&rsquo;d already had some practice setting up a static site in S3 when I recently created <a href=https://github.com/martincostello/credit-card-splitter title="Credit Card Splitter">my first React app</a>. This meant I already had the infrastructure ready to easily start the migration, and I&rsquo;d already practiced some of the mechanics of getting a static site running from a S3 bucket accessed through CloudFront.</p><h2 id=migrating-the-static-content>Migrating the Static Content</h2><p>So to start I needed an S3 bucket. I had actually already created an S3 bucket last year after I found out that your bucket has to have the <em>exact</em> same name as your DNS hostname for the website you want to host, so I wanted to make sure it belonged to me. However, when I&rsquo;d set it up I&rsquo;d set it up in the wrong region. No biggie, I&rsquo;ll just delete it and recreate it right? Almost.</p><img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_one-does-not-simply-recreate-an-s3-bucket.jpg alt="One does not simply recreate an S3 bucket" title="One does not simply recreate an S3 bucket"><p>Turns out that because S3 bucket names are global and because S3 is a distributed system, <strong>fully</strong> deleting an S3 bucket actually takes a non-trivial amount of time. Once I deleted the bucket from the AWS Console, I tried to recreate it in a new region. This failed immediately in the wizard for the first minute or so because it said that a DNS entry for the bucket already existed. Once that error resolved itself I could continue through the wizard to set things up, but it would then fail on the final step with the error:</p><blockquote class=blockquote><p class=mb-0>A conflicting conditional operation is currently in progress against this resource. Please try again.</p></blockquote><p>What? A quick search turns up this <a href=https://stackoverflow.com/a/16553056/1064169 title="Answer on StackOverflow for the error message">answer on StackOverflow</a>. Turns out I just need to wait. For an hour.</p><img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_homer-simpson-chair-goes-round.gif alt="Chair goes round, chair goes round..." title="Chair goes round, chair goes round..."><p>With the S3 bucket effectively moved, it needs configuring to enable Static website hosting with the appropriate index and error pages.</p><p>Once I&rsquo;ve got the S3 bucket created in the correct region, I could press on. The steps were fairly simple:</p><ol><li>Add a deployment section to the <code>.travis.yml</code> file to copy the static content for the site to S3: <a href=https://github.com/martincostello/blog/blob/5db3f6495e8accaaa567171b871a225c4e0f8d57/.travis.yml#L18-L28 title="S3 deployment configuration in GitHub">configuration</a>.</li><li>Copy my TLS certificate to Amazon Certificate Manager in <code>us-east-1</code>.</li><li>Set up a new CloudFront web distribution to serve the content from the S3 bucket (more waiting) with a CNAME for <code>blog.martincostello.com</code>.</li><li>Configure a custom 404 error page for the distribution.</li></ol><h2 id=migrating-the-http-response-headers>Migrating the HTTP Response Headers</h2><p>As the blog is being moved away from IIS, that means I can&rsquo;t set HTTP response headers anymore. Well, I could if I set them manually for <em>every</em> HTML page when uploaded to S3 by Travis CI, but that&rsquo;s a whole lot of faff.</p><p>Fortunately, there&rsquo;s another way to solve this problem.</p><p><strong>Lambda@Edge</strong>, <a href=https://twitter.com/AWSreInvent/status/804394916952408064 title="Lambda@Edge launch announcement">announced at AWS re:Invent 2016</a> and made <a href=https://aws.amazon.com/blogs/aws/lambdaedge-intelligent-processing-of-http-requests-at-the-edge/ title="AWS Lambda@Edge GA announcement blog post">generally available in July 2017</a>, allows you to run code in your CloudFront edge locations in any of four parts of the request path; viewer request and response, and origin request and response. Using a lightweight Lambda function, such as with Node.js, you can run small code snippets that change the behaviour of requests through CloudFront to suit your needs.</p><p>For setting HTTP response headers, this just requires me to add a lambda that runs for <code>viewer-response</code> in CloudFront.</p><p>Setting this up required:</p><ol><li>Writing a Node.js function to set the HTTP response headers: <a href=https://github.com/martincostello/blog/blob/130cdf59633cadac1a1722979757d0b7aadc2768/cloudfront-headers.js title="Lambda function to set the HTTP response headers">code</a>.</li><li>Adding a deployment section to the <code>.travis.yml</code> file to deploy the lambda function to set the response headers: <a href=https://github.com/martincostello/blog/blob/5db3f6495e8accaaa567171b871a225c4e0f8d57/.travis.yml#L43-L56 title="Lambda deployment configuration in GitHub">configuration</a>.</li><li>Updating the IAM policy for the user associated with the AWS access keys Travis CI uses to give it permission to create the new lambda function (I have this locked-down per-function, rather than on a wildcard).</li></ol><p>While it&rsquo;s possible to create a lambda directly from a Travis CI deployment, the IAM role required for a Lambda@Edge function is slightly different as it requires a slightly different trust relationship for the Edge execution. The easiest way to set this up was to use the AWS Console to create it with the <code>cloudfront-modify-response-header</code> template, which can automatically create the correct execution role for you. The policy documents for the role the console created are below.</p><p>One gotcha with Lambda@Edge though, is the way it handles deployment. The functions run in CloudFront are actually replicas of your function, and the <code>$LATEST</code> version is not used. You have to publish a new <strong>numbered</strong> version of your Lambda function, <em>and</em> set up the trigger again manually for the new version you wish to use. Once you associate the trigger with the numbered version, it is <em>replicated</em> to your CloudFront distribution within a few minutes and begins execution on each request.</p><p>I hope that this is something AWS improve the developer experience for in the future so that it&rsquo;s easy to deploy on a rolling basis like the static content is to S3 from Travis CI, rather than something requiring continual manual intervention.</p><img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_lambda-edge-function-trigger.png alt="Lambda@Edge function trigger" title="Lambda@Edge function trigger">
<img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_lambda-edge-function-replica.png alt="Lambda@Edge function replica" title="Lambda@Edge function replica"><h3 id=permissions-policy>Permissions Policy</h3><pre tabindex=0><code>{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Action&#34;: [
        &#34;logs:CreateLogGroup&#34;,
        &#34;logs:CreateLogStream&#34;,
        &#34;logs:PutLogEvents&#34;
      ],
      &#34;Resource&#34;: [
        &#34;arn:aws:logs:*:*:*&#34;
      ]
    }
  ]
}
</code></pre><h3 id=trust-relationship>Trust Relationship</h3><pre tabindex=0><code>{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: [
          &#34;lambda.amazonaws.com&#34;,
          &#34;edgelambda.amazonaws.com&#34;
        ]
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
</code></pre><h2 id=deployed>Deployed(?)</h2><p>With both the static and dynamic parts of the blog set up in AWS, it was time to update the CNAME for my blog to point to the CloudFront distribution&rsquo;s hostname instead of the existing Azure Traffic Manager profile.</p><p>Unfortunately, this wasn&rsquo;t quite as simple as it first seemed&mldr;</p><h3 id=problem-1---jumping-the-gun>Problem 1 - Jumping the Gun</h3><p>I updated my DNS, flushed my DNS host cache and loaded the blog&mldr;and got a security warning in Chrome saying that the TLS certificate didn&rsquo;t match the hostname.</p><p>I double checked the TLS configuration in CloudFront and everything was correct, so I opened the <a href=https://www.ssllabs.com/ssltest/index.html title="Qualys SSL Server Test">Qualys SSL Server Test</a> and pointed it at the blog. Looking right at the bottom of the test results I could see that instead of an HTTP 200 from <code>blog.martincostello.com</code>, I was getting an HTTP 307 from the CloudFront hostname. This explains the warning, but doesn&rsquo;t directly give away the root cause. Some Googling leads to <a href=https://stackoverflow.com/a/38708364/1064169 title="HTTP 307 from CloudFront with S3 origin">this StackOverflow answer</a>, which effectively says that this occurs when the distribution is still provisioning.</p><p>I&rsquo;d waited until the status in the AWS Console had changed to &ldquo;Deployed&rdquo; before changing over the DNS so I was a bit confused. I viewed the distribution in the console again, and it showed as &ldquo;In Progress&rdquo;. I gave it a few minutes and then it changed to &ldquo;Deployed&rdquo; again. Re-running the Qualys test showed things were OK.</p><p>The lesson here is to not be too eager to use a newly created CloudFront distribution - give it a bit of time to settle before starting to request things from it.</p><h3 id=problem-2---why-arent-the-posts-loading>Problem 2 - Why Aren&rsquo;t the Posts Loading?</h3><p>Once the TLS issue was resolved, the homepage of the blog appeared, being served from S3. I check the response headers, and they&rsquo;re being returned as expected from the Lambda@Edge function, so everything looks like it&rsquo;s complete. Then I click through to a post to just do a sanity check&mldr;and I get an XML access denied message. This is unexpected for two reasons:</p><ol><li>Where is the post?</li><li>Where is the custom error page?</li></ol><p>It looks like the post files are missing, so maybe they weren&rsquo;t uploaded to S3? I check the bucket in the AWS Console, and the files are there, but also they aren&rsquo;t.</p><p>It turns out that I&rsquo;d forgotten a behaviour of IIS that was silently powering the blog&rsquo;s URL layout. The posts in this blog have paths like <code>migrating-from-iis-to-s3</code> to make them SEO-friendly, but on-disk those fies don&rsquo;t actually exist, it&rsquo;s a folder. The content is actually at <code>migrating-from-iis-to-s3/index.html</code> as generated by Middleman, but the default IIS static file serving behaviour is to serve the content of <code>index.html</code> from a subdirectory if the path is a folder.</p><p>S3 only exhibits this behaviour for the root path of the S3 bucket, serving a pre-configured file (usually <code>index.html</code>), but this does not apply to subdirectories.</p><p>The solution I came up with to this is effectively the same as the one for HTTP response headers. To fix this I added a second Lambda@Edge function that runs for <code>origin-request</code>. The lambda checks the path of the URL requested, and if it is for an extensionless file (such as <code>migrating-from-iis-to-s3</code>), then it updates the URL to fetch from the origin to be suffixed with <code>/index.html</code>, thus becoming <code>migrating-from-iis-to-s3/index.html</code>.</p><p>All I needed to do was <a href=https://github.com/martincostello/blog/blob/65aaa0be644ac3a39829c295dfe73dfe6ccfb577/cloudfront-folders.js title="function to fix folder paths">add the function code</a>, <a href=https://github.com/martincostello/blog/blob/5db3f6495e8accaaa567171b871a225c4e0f8d57/.travis.yml#L29-L42 title="Travis CI configuration">add the deployment configuration</a> and manually set up the CloudFront trigger again.</p><p>For the custom error page, it turns out that at first it was broken by the same subfolder problem the lambda fixed, but once that was resolved it showed that it was also misconfigured due to a misunderstanding of the S3 behaviour.</p><p>To prevent information disclosure from enumerating the S3 host, any files that do not exist always return an HTTP 403 instead of an HTTP 404 so that an unauthorised user cannot tell the different between a file that does not exist and a file that exists but they do not have access to.</p><p>Fixing the error pages just required adding an additional CloudFront error page to handle HTTP 403 from the origin as HTTP 404 to the viewer using the 404 page from the origin as the response content instead.</p><h2 id=done-and-done>Done and Done</h2><p>So with some ad-hoc fixes for bugs deployed to both S3 and Lambda@Edge, the migration to S3 is complete. I learned a few things by doing along the way, like allowing new CloudFront distributions to settle before using them, leveraged some new AWS functionality, namely Lambda@Edge, and saved some cost and resource in Azure.</p><p>I&rsquo;ve run some tests with <a href=https://www.ssllabs.com/ssltest/index.html title="Qualys SSL Server Test">Qualys</a>, <a href=https://tools.pingdom.com/ title="Pingdom Website Speed Test">Pingdom</a>, <a href=https://developers.google.com/speed/pagespeed/insights/ title="Google PageSpeed Insights">PageSpeed</a> and <a href=https://securityheaders.io/ title=securityheaders.io>securityheaders.io</a>, and everything&rsquo;s looking good. With that I&rsquo;ve now been able to delete the old Azure App Services and Traffic Manager profile, which gives me back some memory and CPU for other sites running on the same App Service Plans (such as <a href=https://londontravel.martincostello.com/ title="London Travel skill website">the site my for my Alexa skill</a>).</p><p>I think if I were to do this again, I&rsquo;d also do more testing on the migrated website from the CloudFront hostname first, before switching over the CNAME record in DNSimple. Don&rsquo;t fool yourself into thinking you don&rsquo;t need to do much testing because there&rsquo;s no code involved because it&rsquo;s a static site - infrastructure also needs testing!</p><p>Of course, now I should probably blog a bit more often to justify this S3 migration&mldr;</p><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Migrating+to+Amazon+S3+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fmigrating-to-amazon-s3%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/1e081eee55dfb7b252dce3b0ab73a36513d14253 rel=noopener title="View commit 1e081eee55dfb7b252dce3b0ab73a36513d14253 on GitHub">1e081ee</a> on <a href=https://github.com/martincostello/blog/tree/copilot/fix-244 rel=noopener title="View branch copilot/fix-244 on GitHub">copilot/fix-244</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>