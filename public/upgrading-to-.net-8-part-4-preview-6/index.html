<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>Upgrading to .NET 8: Part 4 - Preview 6 | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Highlights from upgrading to .NET 8 preview 6"><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="dotnet,preview,upgrade"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2023-07-19T00:00:00Z"><meta property="article:modified_time" content="2023-07-19T00:00:00Z"><meta property="article:tag" content="dotnet,preview,upgrade"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Highlights from upgrading to .NET 8 preview 6"><meta property="og:image" content="https://cdn.martincostello.com/blog_dotnet-bot.png"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="Upgrading to .NET 8: Part 4 - Preview 6"><meta property="og:type" content="article"><meta property="og:updated_time" content="2023-07-19T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/upgrading-to-.net-8-part-4-preview-6/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Highlights from upgrading to .NET 8 preview 6"><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/blog_dotnet-bot.png"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="Upgrading to .NET 8: Part 4 - Preview 6"><meta name=twitter:url content="https://blog.martincostello.com/upgrading-to-.net-8-part-4-preview-6/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/upgrading-to-.net-8-part-4-preview-6/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>Upgrading to .NET 8: Part 4 - Preview 6</h1><p class="col-md-8 fs-4 lead">Highlights from upgrading to .NET 8 preview 6</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>19 July 2023 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>19 July 2023 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Upgrading+to+.NET+8%3A+Part+4+-+Preview+6+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fupgrading-to-.net-8-part-4-preview-6%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><p>Following on from <a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-3-previews-1-to-5 title="Previews 1-5">part 3</a> of this series, I&rsquo;ve been continuing
to upgrade my projects to .NET 8 - this time to preview 6. In this post
I&rsquo;ll cover more experiences with the new source generators with this
preview as well as a new feature of C# 12: <em>primary constructors</em>.</p><p>READMORE</p><h2 id=more-fun-with-source-generators>More Fun with Source Generators</h2><h3 id=request-delegate-generator---round-3>Request Delegate Generator - Round 3</h3><p>Preview 6 includes further changes to the <em><a href=https://devblogs.microsoft.com/dotnet/asp-net-core-updates-in-dotnet-8-preview-3/#minimal-apis-and-native-aot title="Minimal APIs and native AOT">Request Delegate Generator</a></em>
since last month&rsquo;s preview 5, so time to dive in again and see how things
are shaping up.</p><p>This release included <a href=https://github.com/dotnet/aspnetcore/pull/48377 title="Add [GeneratedCode] for more RDG output">what I thought was the fix</a>
to exclude the generated code from the code coverage reports. However, it
turns out that I misunderstood the coverlet code coverage defaults, and
generated code still isn&rsquo;t excluded by default. It&rsquo;s still desirable that the
code that&rsquo;s generated has this attribute, so it&rsquo;s not a wasted effort, but
it means that it still requires me to change my coverlet configuration to
not include the code in my coverage reports.</p><p>This is easily fixed with the following addition to my project files where
I use the coverlet MSBuild integration: <code>&lt;ExcludeByAttribute>GeneratedCodeAttribute&lt;/ExcludeByAttribute></code>.</p><p>Once I updated my configuration, I enabled the Request Delegate Generator in
<a href=https://gist.github.com/martincostello/2083bcc83f30a5038175e4f31e0fc59f/a8ecc1f7f07f1e51b1ab96966710e8cdbc8cc088 title=".NET vNext Upgrade Report on 18/07/2023">all of the repositories I&rsquo;m testing .NET 8 with</a>.
This was mostly successful, but I did find two issues with the generator.</p><p>The first was <a href=https://github.com/dotnet/aspnetcore/issues/49381 title="Request Delegate Generator fails to compile code with CS8601 warning for required non-nullable record parameters">an issue with</a> code being generated
that didn&rsquo;t honour nullable reference types correctly for a required struct.
As of writing this blog post this is still being looked into.</p><p><a href=https://github.com/dotnet/aspnetcore/issues/49384 title="Request Delegate Generator fails to compile code with CS0246 error for endpoint with generic type parameter">The second issue</a> was that the generator wasn&rsquo;t
emitting code correctly where the lambda method for the endpoint captures
a type parameter from the method calling the <code>Map*()</code> method. For example:</p><pre class="highlight plaintext">
<code>public static RouteHandlerBuilder MapRepositoryUpdate&lt;T&gt;(
    this IEndpointRouteBuilder endpoints,
    string pattern,
    Func&lt;IConfigurationRepository, RepositoryId, T, CancellationToken, Task&lt;bool&gt;&gt; operation)
{
    return endpoints.MapPatch(pattern, async (
        long installationId,
        long repositoryId,
        [FromBody] Payload&lt;T&gt; request,
        InstallationService service,
        IConfigurationRepository repository,
        CancellationToken cancellationToken) =>
    {
        if (!await service.UserHasAccessToRepositoryAsync(installationId, repositoryId))
        {
            return Results.NotFound();
        }
&nbsp;
        await repository.EnsureRepositoryAsync(repositoryId, cancellationToken);
&nbsp;
        return await operation(repository, new(repositoryId), request.Value, cancellationToken) switch
        {
            false => Results.Conflict(),
            true => Results.NoContent(),
        };
    }).RequireAuthorization();
}

internal sealed record Payload&lt;T&gt;(T Value);</code>
</pre><p>This turned out to be a <a href=https://github.com/dotnet/aspnetcore/issues/47338 title="RDG does not support generic types from outer scope">known issue</a>, but unfortunately
it doesn&rsquo;t appear to be in scope to be resolved as part of the .NET 8 release.
Instead in preview 7 the generator will <a href=https://github.com/dotnet/aspnetcore/pull/49417 title="Emit diagnostics for unsupported RDG scenarios">emit a warning</a>
for this scenario (and others) that aren&rsquo;t supported as part of this year&rsquo;s release.</p><p>Along with this testing, <a href=https://github.com/captainsafia title="@captainsafia on GitHub">Safia Abdalla</a> from the ASP.NET Core team
reached out to me and asked if I&rsquo;d do some testing with the latest nightly builds
of ASP.NET Core with Request Delegate Generator enabled. This is because
<a href=https://github.com/dotnet/aspnetcore/pull/48817 title="Update RDG to use interceptors feature">quite a big change</a> was made for preview 7 to build the
source generators on top of the new C# 12 feature: <em><a href=https://devblogs.microsoft.com/dotnet/new-csharp-12-preview-features/#interceptors title=Interceptors>Interceptors</a></em>.</p><p>I was happy to help, so I updated a few of my projects to use the latest nightly builds
from the <a href=https://github.com/dotnet/installer title="dotnet/installer on GitHub">dotnet/installer</a> repository. I didn&rsquo;t find any issues
with the changes which is a great sign for preview 7 on that front, but I did find
<a href=https://github.com/dotnet/runtime/issues/88842 title="AccessViolationException or InvalidOperationException thrown in local method with .NET 8 preview 7 nightly">a new issue</a> with the Just in Time (JIT) compiler related
to <a href=https://en.wikipedia.org/wiki/Single_instruction,_multiple_data title="Single instruction, multiple data">SIMD12</a> instructions on Linux x64 that caused my tests to crash. This
issue should be fixed as part of preview 7 too.</p><h3 id=configuration-binding-source-generator>Configuration Binding Source Generator</h3><p>From one source generator to another, preview 6 also includes various fixes
to the <a href=https://devblogs.microsoft.com/dotnet/announcing-dotnet-8-preview-6/#configuration-binding-source-generator-improvements title="Configuration binding source generator improvements">Configuration Binding Source Generator</a>
that was introduced in preview 3. I hadn&rsquo;t tried this out yet, so again I
turned this on in all of the repositories I&rsquo;m testing .NET 8 with. This was
certainly a fruitful excercise in terms of finding bugs!</p><p>Across the various repositories I turned the generator on for, I found a
total of four different issues with the code produced by the generator.</p><ul><li>Another variant on the <code>[GeneratedCode]</code> attribute missing, impacting code coverage - <a href=https://github.com/dotnet/runtime/issues/89007 title="CoreBindingHelper for configuration binding source generator should be marked as [GeneratedCode]">dotnet/runtime#89007</a></li><li>A compiler error generating code for a struct - <a href=https://github.com/dotnet/runtime/issues/89010 title="Configuration binding source generator fails with CS8598 error">dotnet/runtime#89010</a></li><li>The generator failing to generate any code on Linux and macOS - <a href=https://github.com/dotnet/runtime/issues/89014 title="Configuration binding source generator throws ArgumentOutOfRangeException on macOS and Linux">dotnet/runtime#89014</a></li><li>A compiler error generating code for for nullable reference types - <a href=https://github.com/dotnet/runtime/issues/89019 title="Configuration binding source generator fails to compile with CS8600 when using nullable reference types">dotnet/runtime#89019</a></li></ul><p>As a bonus, while the .NET team investigated the issues I found, they also
found a fifth issue where <a href=https://github.com/dotnet/runtime/issues/89043 title="When binding to interface collections, config generator shouldn't generate logic for both interface & mapping collection type.">redundant code was being generated</a>.</p><p>I think these issues again highlight how valuable community testing of pre-releases
of .NET can be. Finding these issues earlier allows for more use cases to
be flushed out while features are still under development, leading to the
new features being more stable and having more depth of coverage ahead of
release candidates and the final release being made available. The sooner
issues are identified, the more time the .NET team has to fix them before
shipping! ðŸš¢</p><h2 id=primary-constructors>Primary Constructors</h2><p><em><a href=https://devblogs.microsoft.com/dotnet/check-out-csharp-12-preview/#primary-constructors-for-non-record-classes-and-structs title="Primary constructors for non-record classes and structs">Primary constructors</a></em> are a new feature in C# 12.
In short, they allow you remove the need to define a traditional explicit
constructor to pass parameters to use in a class or struct. Instead, you
declare the parameters as part of the class/struct declaration, where you
can then capture the parameters to use in the members of the type, such as
to assign the default value of a property.</p><p>To use primary constructors, you just need to opt-in to C#12 by enabling
preview language features in the .NET SDK in your project file(s) (or in
<code>Directory.Build.props</code>) like this: <code>&lt;LangVersion>preview&lt;/LangVersion></code></p><p>This isn&rsquo;t a new feature in preview 6, but this is the first preview I&rsquo;ve
tried it out with. To be honest, I wasn&rsquo;t particularly excited about this
feature when it was first announced, but now I&rsquo;ve tried it I&rsquo;ve been won
over. Suprisingly, the place that really won me over was in some of my
test code!</p><p>For example, <a href=https://blog.martincostello.com/writing-logs-to-xunit-test-output/ title="Writing Logs to xunit Test Output">to output logs from ASP.NET Core in xunit tests</a>,
you need to pass an instance of <code>ITestOutputHelper</code> to the constructor of
your test class. This then lets you redirect the logs from your application under
test to xunit using a package such as <a href=https://github.com/martincostello/xunit-logging#readme title="martincostello/xunit-logging on GitHub">my xunit logging NuGet package</a>.</p><p>In many of my projects, I have a base class for my tests that handles
this for me, but it still needs the derived test classes to also declare
a constructor to pass through the <code>ITestOutputHelper</code> instance. This results
in a test class that looks something like this:</p><pre class="highlight plaintext"><code>public class MyTests : TestsBase
{
    public MyTests(ITestOutputHelper outputHelper)
        : base(outputHelper)
    {
    }
&nbsp;
    // Here be tests...
}</code>
</pre><p>With the adoption of primary constructors, this can be simplified to
the following:</p><pre class="highlight plaintext"><code>public class MyTests(ITestOutputHelper outputHelper) : TestsBase(outputHelper)
{
    // Here be tests...
}</code>
</pre><p>Code formatting preferences aside, I think this is a great improvement
as it not just reduces the number of lines of code you need in your types,
but I think it also makes the code a lot neater and has less ceremony.</p><p>This is one of those changes where I might however not adopt the change
en masse in existing projects to reduce code churn for peers reviewing
pull requests, but is the sort of change I&rsquo;d slowly adopt over time as
I&rsquo;m working on a project asI touch individual files.</p><p>Overall I think this is a nice addition to C# as it continues to evolve.</p><h2 id=summary>Summary</h2><p>In this post we looked at the latest changes to the new source generators
coming as part of the .NET 8 release, as well as looking at a use case for
adopting primary constructors.</p><p>In the next post in this series, we&rsquo;ll take a look at upgrading to .NET 8
Preview 7 as well as release candidates 1 and 2: <em><a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-5-preview-7-and-rc-1-2 title="Preview 7 and Release Candidates 1 and 2">Part 5 - Preview 7 and Release Candidates 1 and 2</a></em>.</p><h2 id=upgrading-to-net-8-series-links>Upgrading to .NET 8 Series Links</h2><p>You can find links to the other posts in this series below.</p><ul><li><a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-1-why-upgrade title="Why Upgrade?">Part 1 - Why Upgrade?</a></li><li><a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-2-automation-is-our-friend title="Automation is our Friend">Part 2 - Automation is our Friend</a></li><li><a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-3-previews-1-to-5 title="Previews 1-5">Part 3 - Previews 1-5</a></li><li>Part 4 - Preview 6 (this post)</li><li><a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-5-preview-7-and-rc-1-2 title="Preview 7 and Release Candidates 1 and 2">Part 5 - Preview 7 and Release Candidates 1 and 2</a></li><li><a href=https://blog.martincostello.com/upgrading-to-dotnet-8-part-6-stable-release title="The Stable Release">Part 6 - The Stable Release</a></li></ul><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Upgrading+to+.NET+8%3A+Part+4+-+Preview+6+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fupgrading-to-.net-8-part-4-preview-6%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/1e081eee55dfb7b252dce3b0ab73a36513d14253 rel=noopener title="View commit 1e081eee55dfb7b252dce3b0ab73a36513d14253 on GitHub">1e081ee</a> on <a href=https://github.com/martincostello/blog/tree/copilot/fix-244 rel=noopener title="View branch copilot/fix-244 on GitHub">copilot/fix-244</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>