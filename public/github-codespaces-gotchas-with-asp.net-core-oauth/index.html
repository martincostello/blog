<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>GitHub Codespaces Gotchas with ASP.NET Core OAuth | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Some gotchas to account for when debugging an ASP.NET Core app using OAuth with GitHub Codespaces"><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="aspnet,aspnetcore,codespaces,dotnet,github,oauth"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2021-08-15T00:00:00Z"><meta property="article:modified_time" content="2021-08-15T00:00:00Z"><meta property="article:tag" content="aspnet,aspnetcore,codespaces,dotnet,github,oauth"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Some gotchas to account for when debugging an ASP.NET Core app using OAuth with GitHub Codespaces"><meta property="og:image" content="https://cdn.martincostello.com/martin_small-v3.png"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="GitHub Codespaces Gotchas with ASP.NET Core OAuth"><meta property="og:type" content="article"><meta property="og:updated_time" content="2021-08-15T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/github-codespaces-gotchas-with-asp.net-core-oauth/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Some gotchas to account for when debugging an ASP.NET Core app using OAuth with GitHub Codespaces"><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/martin_small-v3.png"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="GitHub Codespaces Gotchas with ASP.NET Core OAuth"><meta name=twitter:url content="https://blog.martincostello.com/github-codespaces-gotchas-with-asp.net-core-oauth/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/github-codespaces-gotchas-with-asp.net-core-oauth/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>GitHub Codespaces Gotchas with ASP.NET Core OAuth</h1><p class="col-md-8 fs-4 lead">Some gotchas to account for when debugging an ASP.NET Core app using OAuth with GitHub Codespaces</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>15 August 2021 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>15 August 2021 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=GitHub+Codespaces+Gotchas+with+ASP.NET+Core+OAuth+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fgithub-codespaces-gotchas-with-asp.net-core-oauth%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><p>This week GitHub <a href=https://docs.github.com/codespaces title="GitHub Codespaces Documentation">Codespaces</a> was made <a href=https://github.blog/changelog/2021-08-11-codespaces-is-generally-available-for-team-and-enterprise/ title="Codespaces is generally available for Team and Enterprise">generally available</a> for Teams and
Enterprise, and coupled with the release of the ability to open any repository
in <a href=https://code.visualstudio.com/ title="Visual Studio Code">Visual Studio Code</a> in a web browser <a href="https://twitter.com/github/status/1425505817827151872?s=20" title="New shortcut: Press . on any GitHub repo.">just by pressing <code>.</code></a>, I thought
I&rsquo;d give it a try with some existing projects. In the process I hit a few
gotchas that took me a few hours to get to the bottom of. This post goes through
some of those and how to resolve them.</p><p>READMORE</p><p>One of the projects I decided I&rsquo;d try it out on is the <a href=https://github.com/martincostello/dotnet-minimal-api-integration-testing title="dotnet-minimal-api-integration-testing on GitHub.com">sample application</a> I
recently published for integration testing with ASP.NET Core 6 <a href=https://devblogs.microsoft.com/aspnet/asp-net-core-updates-in-net-6-preview-4/#introducing-minimal-apis title="Introducing minimal APIs">Minimal APIs</a>.
This sample uses <a href=https://www.nuget.org/packages/AspNet.Security.OAuth.GitHub/ title="AspNet.Security.OAuth.GitHub on NuGet.org">GitHub OAuth</a> for authentication and is relatively simple
in its setup, with a mostly out-of-the box configuration.</p><p>Once I&rsquo;d got the basic Codespaces setup added to the repository (which took me a
bit of time to bed-in and sort out), I found that whenever I tried to log in to
the sample application using the Codespaces preview URL when I ran it in the
debugger, I&rsquo;d be greeted with an HTTP 405 error (<a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/405 title="405 Method Not Allowed">Method Not Allowed</a>).</p><img class="img-fluid mx-auto d-block" src=https://cdn.martincostello.com/blog_http-405.png alt="HTTP 405 error" title="HTTP 405 error"><p>However, the error page wasn&rsquo;t coming from my app. The <code>Server</code> HTTP response
header identified it as NGINX, and turning up the default log level to <code>Trace</code>
didn&rsquo;t show any requests hitting the app in the debugger for the <code>/signin</code> path
the form POST was sent to.</p><p>Weird. Confused, I posted <a href=https://github.community/t/port-forwarding-for-http-post-not-working/195407 title="Port Forwarding for HTTP POST not working">a question</a> on the GitHub Support Community and
left it for the rest of the day.</p><p>This weekend, I then went through some other repos to add Codespaces support to.
The setup was pretty much the same as with the first one I tried, yet any HTTP
POST resources those apps had in them worked fine.</p><p>Curious. What is it about this particular TodoApp that means that it gets an
HTTP 405 when trying to post to the <code>/signin</code> path?</p><p>After <em>quite</em> a lot of trial and error, I found that <code>/signin</code> appears to be
some sort of reserved path that the GitHub Codespaces internals use. I haven&rsquo;t
been able to find any documentation about this anywhere about paths that you
cannot use, so I guess it&rsquo;s some sort of the internal management functionality
for their devs or something like that.</p><p>Once I changed the path in the app to <code>/sign-in</code>, I could hit the GitHub.com
OAuth page to grant permission to my app and get redirected back to complete
the OAuth dance to get logged in.</p><p>The next hurdle was that my OAuth callback path would 404. Seems that the NGINX
setup in Codespaces seems to also trap paths beginning with <code>/signin</code>. As the
out-of-the-box callback path was <code>/signin-github</code>, I needed to change that too.</p><p>With that sorted out, I had a third and final problem. GitHub would reject the
callback URL as invalid. Inspecting the logs in the debugger, I found that the
redirect URL being sent to GitHub was starting with <code>https://localhost/</code>. For
some reason the hostname for the Codespaces preview wasn&rsquo;t being used by the app.</p><p>At first I thought I&rsquo;d just need to explicitly configure the ASP.NET Core <a href=https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer#forward-the-scheme-for-linux-and-non-iis-reverse-proxies title="Forward the scheme for Linux and non-IIS reverse proxies">proxy
configuration for Linux</a>, but that didn&rsquo;t seem to fix it either. Finally I
resorted to reading the source code for the <code>ForwardedHeadersMiddleware</code> class
in the ASP.NET Core repo and then I found <a href=https://github.com/dotnet/aspnetcore/blob/bcfbd5cc47dde7f2be50a24721f24a020dc77356/src/Middleware/HttpOverrides/src/ForwardedHeadersMiddleware.cs#L191-L193 title="ForwardedHeadersMiddleware source code on GitHub.com">the answer</a>.</p><p>By default, the <code>X-Forwarded-Host</code> HTTP request header is not inspected by the
middleware to update the value of the <code>Host</code> property on the <code>HttpRequest</code>.
Once I updated the configuration for the forwarded headers middleware, the OAuth
login flow for the application started to work.</p><p>I also subsequently found that the documentation on docs.microsoft.com is a bit
<a href=https://github.com/dotnet/AspNetCore.Docs/issues/18532#issuecomment-637092890 title="Comment about out-of-date documentation">out of date</a> and that there has been a config value <a href=https://devblogs.microsoft.com/aspnet/forwarded-headers-middleware-updates-in-net-core-3-0-preview-6/#configuration-only-wire-up-in-preview-6 title="Configuration-only Wire-up in Preview 6">built-in since ASP.NET
Core 3.0</a> that will automatically configure the middleware for you if you set the
<code>ASPNETCORE_FORWARDEDHEADERS_ENABLED</code> setting to <code>true</code>.</p><p>This meant I could simplify the code to just two lines in the <code>Program.cs</code> file
to add on the additional flag for the middleware:</p><pre tabindex=0><code>if (string.Equals(
        builder.Configuration[&#34;CODESPACES&#34;],
        &#34;true&#34;,
        StringComparison.OrdinalIgnoreCase))
{
    builder.Services.Configure&lt;ForwardedHeadersOptions&gt;(
        options =&gt; options.ForwardedHeaders |= ForwardedHeaders.XForwardedHost);
}
</code></pre><p>With that in place, I could just set up the forwarded headers from the VS Code
launch configuration:</p><pre tabindex=0><code>&#34;env&#34;: {
  &#34;ASPNETCORE_FORWARDEDHEADERS_ENABLED&#34;: &#34;${env:CODESPACES}&#34;
}
</code></pre><p>Now the app works correctly when running in GitHub Codespaces! 🎉</p><p>You can see the full set of changes I made to get things working for the sample
app when running in Codespaces in <a href=https://github.com/martincostello/dotnet-minimal-api-integration-testing/pull/100/files>this Pull Request</a>.</p><p>This was quite the head-scratcher to work out and fix, but I&rsquo;m glad that I&rsquo;ve
gotten things working in the end to give a nicer experience to people looking at
my sample repo with Codespaces without neeeding to clone it locally.</p><p>If you&rsquo;ve stumbled across the blog post while trying to get this working
yourself, I hope you found reading this useful!</p><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=GitHub+Codespaces+Gotchas+with+ASP.NET+Core+OAuth+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fgithub-codespaces-gotchas-with-asp.net-core-oauth%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/4116b929c2636f9c037d8c2a6c02e0a2140cd9fc rel=noopener title="View commit 4116b929c2636f9c037d8c2a6c02e0a2140cd9fc on GitHub">4116b92</a> on <a href=https://github.com/martincostello/blog/tree/copilot/fix-244 rel=noopener title="View branch copilot/fix-244 on GitHub">copilot/fix-244</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>