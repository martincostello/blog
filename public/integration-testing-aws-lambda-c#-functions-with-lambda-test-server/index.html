<!doctype html><html lang=en-gb><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><title>Integration testing AWS Lambda C# Functions with Lambda Test Server | The blog of a software developer and tester.</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="author" content="Martin Costello"><meta name=copyright content="&copy; Martin Costello 2014-2025"><meta name=description content="Using Lambda Test Server to integration test your C# AWS Lambda functions for .NET Core locally when using a custom runtime."><meta name=language content="en"><meta name=theme-color content="#ffffff"><meta name=keywords content="aws,dotnet,lambda,testing"><meta name=robots content="INDEX"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="article:author" content="10100867762061905"><meta property="article:published_time" content="2019-11-11T00:00:00Z"><meta property="article:modified_time" content="2019-11-11T00:00:00Z"><meta property="article:tag" content="aws,dotnet,lambda,testing"><meta property="fb:profile_id" content="10100867762061905"><meta name=application-name content="Martin Costello's Blog"><meta name=msapplication-config content="browserconfig.xml"><meta name=msapplication-navbutton-color content="#0095DA"><meta name=msapplication-starturl content="/"><meta property="og:description" content="Using Lambda Test Server to integration test your C# AWS Lambda functions for .NET Core locally when using a custom runtime."><meta property="og:image" content="https://cdn.martincostello.com/blog_lambda-dotnet-core.png"><meta property="og:locale" content="en_GB"><meta property="og:site_name" content="Martin Costello's Blog"><meta property="og:title" content="Integration testing AWS Lambda C# Functions with Lambda Test Server"><meta property="og:type" content="article"><meta property="og:updated_time" content="2019-11-11T00:00:00Z"><meta property="og:url" content="https://blog.martincostello.com/integration-testing-aws-lambda-c%23-functions-with-lambda-test-server/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@martin_costello"><meta name=twitter:description content="Using Lambda Test Server to integration test your C# AWS Lambda functions for .NET Core locally when using a custom runtime."><meta name=twitter:domain content="blog.martincostello.com"><meta name=twitter:image content="https://cdn.martincostello.com/blog_lambda-dotnet-core.png"><meta name=twitter:image:alt content="Martin Costello"><meta name=twitter:site content="@martin_costello"><meta name=twitter:title content="Integration testing AWS Lambda C# Functions with Lambda Test Server"><meta name=twitter:url content="https://blog.martincostello.com/integration-testing-aws-lambda-c%23-functions-with-lambda-test-server/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Martin Costello"><meta name=google-site-verification content="ji6SNsPQEbNQmF252sQgQFswh-b6cDnNOa3AHvgo4J0"><meta name=msvalidate.01 content="D6C2E7551C902F1A396D8564C6452930"><link rel=canonical href=https://blog.martincostello.com/integration-testing-aws-lambda-c%23-functions-with-lambda-test-server/><link rel=manifest href=/manifest.webmanifest><link href=https://cdn.martincostello.com/favicon.ico rel="shortcut icon" type=image/x-icon><link href=/sitemap.xml rel=sitemap type=application/xml><link href=/feed.xml rel=alternate type=application/rss+xml title=Atom></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand><span class="fa-solid fa-laptop-code" aria-hidden=true></span>
blog.martincostello.com
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#site-navbar aria-controls=site-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=site-navbar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/archive/ title="View the post archive">Archive
<span class="fa-solid fa-box-archive" aria-hidden=true></span></a></li></ul><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-me/ title="About Martin">About Me
<span class="fa-solid fa-circle-info" aria-hidden=true></span></a></li></ul></div></div></nav><main class="container body-content"><div class="p-4 mb-3 bg-light rounded-3"><div class="container-fluid py-3"><h1 class=display-5>Integration testing AWS Lambda C# Functions with Lambda Test Server</h1><p class="col-md-8 fs-4 lead">Using Lambda Test Server to integration test your C# AWS Lambda functions for .NET Core locally when using a custom runtime.</p></div></div><p><div class="row d-none d-md-block"><div class=col-6>11 November 2019 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a> |
<a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></div></div><div class="row d-md-none"><div class=col-12>11 November 2019 by <a href=/about-me/ rel=noopener title="About Martin Costello">Martin Costello</a></div><div class=col-12><a href=/feed.xml rel=noopener title="View the RSS syndication feed"><span class="fa-solid fa-rss" aria-hidden=true></span></a></p></div></div></p><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Integration+testing+AWS+Lambda+C%23+Functions+with+Lambda+Test+Server+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fintegration-testing-aws-lambda-c%2523-functions-with-lambda-test-server%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><p><em>Lambda Test Server</em> is a .NET Core 3.0 library available from <a href=https://www.nuget.org/packages/MartinCostello.Testing.AwsLambdaTestServer/ title="MartinCostello.Testing.AwsLambdaTestServer on NuGet.org">NuGet</a> which builds on top of the <a href=https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver title="TestServer Class on Microsoft Docs"><code>TestServer</code></a> class in the <a href=https://www.nuget.org/packages/Microsoft.AspNetCore.TestHost/ title="Microsoft.AspNetCore.TestHost on NuGet.org">Microsoft.AspNetCore.TestHost NuGet package</a> to provide infrastructure to use with end-to-end/integration tests for .NET Core AWS Lambda Functions using a <a href=https://aws.amazon.com/blogs/developer/net-core-3-0-on-lambda-with-aws-lambdas-custom-runtime/ title=".NET Core 3.0 on Lambda with AWS Lambdaâ€™s Custom Runtime">custom runtime</a>.</p><p>The example below shows how <em>Lambda Test Server</em> can be used to write an xunit integration test for a simple C# Lambda function that reverses an array of integers:</p><pre tabindex=0><code>[Fact]
public static async Task Function_Reverses_Numbers()
{
    // Arrange
    using var server = new LambdaTestServer();
    using var cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(1));

    await server.StartAsync(cancellationTokenSource.Token);

    int[] value = new[] { 1, 2, 3 };
    string json = JsonConvert.SerializeObject(value);

    LambdaTestContext context = await server.EnqueueAsync(json);

    using var httpClient = server.CreateClient();

    // Act
    await ReverseFunction.RunAsync(httpClient, cancellationTokenSource.Token);

    // Assert
    Assert.True(context.Response.TryRead(out LambdaTestResponse response));
    Assert.True(response.IsSuccessful);

    json = await response.ReadAsStringAsync();
    int[] actual = JsonConvert.DeserializeObject&lt;int[]&gt;(json);

    Assert.Equal(new[] { 3, 2, 1 }, actual);
}
</code></pre><p>The source is available <a href=https://github.com/martincostello/lambda-test-server title="Lambda Test Server on GitHub.com">in GitHub</a> - pull requests are welcome!</p><p>Further samples for using the library with xunit are available in GitHub here: <a href=https://github.com/martincostello/lambda-test-server/tree/main/samples title="Lambda Test Server samples on GitHub.com">https://github.com/martincostello/lambda-test-server/tree/main/samples</a></p><p>READMORE</p><h2 id=background>Background</h2><p>Back in mid-October I received an email from AWS stating that my Lambda functions using Node.js 8.10 needed to be updated to version 10 as 8.10 was going to be <a href=https://docs.aws.amazon.com/lambda/latest/dg/runtime-support-policy.html title="AWS Lambda Runtime Support Policy">deprecated at the start of 2020</a>.</p><p>I have a few Lambda@Edge functions that are used for <a href=https://blog.martincostello.com/migrating-from-iis-to-s3/ title="Migrating to Amazon S3">this blog</a> that were easy enough to update, but I also have a published Alexa skill, <a href=https://www.amazon.co.uk/Martin-Costello-London-Travel/dp/B01NB0T86R title="London Travel Alexa skill on amazon.co.uk"><em>London Travel</em></a>, that was also using node 8.10 that isn&rsquo;t as simple.</p><p>While it was still <a href=https://github.com/martincostello/alexa-london-travel/pull/123 title="Update to Node.js 10">very easy</a> to migrate the function for Node.js 10, I thought it might be a good opportunity to take the time to rewrite the Lambda function that powers the skill in C# using .NET Core. I had some tasks coming up at work to migrate various .NET Core 3.0 worker services running on EC2 that my team maintains to be Lambda functions, so I figured this would be a good learning opportunity before tackling some high-throughput production workloads.</p><p>So first I <a href=https://github.com/martincostello/alexa-london-travel/pull/124 title="Rewrite skill as .NET Core">rewrote the skill in C#</a> targeting .NET Core 2.1 and deployed it, then I started looking into the upgrade to 3.0.</p><p>AWS Lambda has built-in support for .NET Core 2.1, which at the time of writing is the Long Term Service (LTS) version, but no runtime support for .NET Core 2.2 or the <a href=https://devblogs.microsoft.com/dotnet/announcing-net-core-3-0/ title="Announcing .NET Core 3.0">recently released</a> .NET Core 3.0. Even though support for .NET Core 3.x is likely to be available in the next few months when .NET Core 3.1 is released (which will be the <a href=https://devblogs.microsoft.com/dotnet/announcing-net-core-3-1-preview-1/ title="Announcing .NET Core 3.1 Preview 1">next LTS release</a>), I didn&rsquo;t want to wait around to be able to benefit from .NET Core 3.0&rsquo;s various <a href=https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-3-0/ title="Performance Improvements in .NET Core 3.0">performance improvements</a>.</p><p>AWS does however allow you to bring your own runtime for Lambda using <a href=https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html title="Custom AWS Lambda Runtimes">custom runtimes</a> and the <code>LambdaBootstrap</code> class from the <a href=https://www.nuget.org/packages/Amazon.Lambda.RuntimeSupport/ title="Amazon.Lambda.RuntimeSupport on NuGet.org">Amazon.Lambda.RuntimeSupport</a> NuGet package. Following the <a href=https://aws.amazon.com/blogs/developer/net-core-3-0-on-lambda-with-aws-lambdas-custom-runtime/ title=".NET Core 3.0 on Lambda with AWS Lambdaâ€™s Custom Runtime">AWS blog post</a> about .NET Core 3.0 as well as my colleague <a href=https://twitter.com/zaccharles title="Zac Charles on Twitter">Zac Charles&rsquo;</a> <a href=https://medium.com/@zaccharles/net-core-3-0-aws-lambda-benchmarks-and-recommendations-8fee4dc131b0 title=".NET Core 3.0 AWS Lambda Benchmarks and Recommendations">recommendations for .NET Core 3.0 Lambdas</a>, I updated the function to <a href=https://github.com/martincostello/alexa-london-travel/pull/137 title="Update to .NET Core 3.0">target .NET Core 3.0</a> and deployed it too.</p><p>It was at this point with the EC2 to Lambda migration work about to start that I started thinking about how to make it easier to integration test such a Lambda without having to deploy the code into the AWS Lambda runtime first. This wasn&rsquo;t about AWS hosting costs, but about helping to <em>&ldquo;shift left&rdquo;</em> the testing - decreasing the cycle time for iterating on the implementation of the Lambda functions as I wrote the code on my laptop.</p><p>After looking through <a href=https://github.com/aws/aws-lambda-dotnet/tree/master/Libraries/src/Amazon.Lambda.RuntimeSupport title="Amazon.Lambda.RuntimeSupport on GitHub.com">the code</a> for <code>LambdaBootstrap</code> and seeing what it did, I decided to write a test server that emulated the AWS Lambda runtime environment to allow running the code as close to a <em>&ldquo;black box&rdquo;</em> as possible in tests to validate the Lambda function.</p><h2 id=how-it-works>How It Works</h2><p>Under-the-hood, the AWS Lambda runtime works by exposing an HTTP API with four resources that are used to drive a message-pump that processes messages, one of which is an &ldquo;input&rdquo; with the other three being for &ldquo;output&rdquo;.</p><p>The runtime code effectively runs an infinite while-loop which calls the <code>GET /{LambdaVersion}/runtime/invocation/next</code> resource and processes the content of the HTTP responses. The responses also contain metadata about the function in the headers, such as the AWS request Id and function ARN.</p><p>Once the function code has handled the request, the runtime either calls the <code>POST /{LambdaVersion}/runtime/invocation/{AwsRequestId}/response</code> resource for successfully processed requests or the <code>POST /{LambdaVersion}/runtime/invocation/{AwsRequestId}/error</code> resource to report errors. The fourth resource is used to handle failed function initialization: <code>POST /{LambdaVersion}/runtime/init/error</code>.</p><p>In theory this works like HTTP long-polling within your function, but in practice the AWS Lambda Runtime freezes the function process if there are no pending messages to invoke your code with.</p><p>Equipped with this knowledge and further reverse-engineering of the .NET Lambda runtime support, I started to implement <em>Lambda Test Server</em>, starting with a <a href=https://github.com/martincostello/alexa-london-travel/pull/139 title="Add Lambda test server for integration tests">proof-of-concept</a> which I committed directly into the repo for my Alexa skill.</p><p>It uses ASP.NET Core 3.0&rsquo;s <code>TestServer</code> and <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-3.0" title="Routing in ASP.NET Core">endpoint routing</a> to implement an in-memory HTTP server exposed via <code>HttpClient</code>. Requests for the Lambda to process can be queued with the server and are delivered to the message pump sequentially over &ldquo;HTTP&rdquo; and are then passed to the Lambda function being tested, with the response being posted back into the runtime.</p><p>Here&rsquo;s an excerpt of the code (tweaked for brevity) that sets up the HTTP endpoints for the emulated Lambda runtime:</p><pre tabindex=0><code>protected virtual void Configure(IApplicationBuilder app)
{
    app.UseRouting();
    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapGet(&#34;/{Version}/runtime/invocation/next&#34;, OnNext);
        endpoints.MapPost(&#34;/{Version}/runtime/init/error&#34;, OnInitializationError);
        endpoints.MapPost(&#34;/{Version}/runtime/invocation/{RequestId}/error&#34;, OnInvocationError);
        endpoints.MapPost(&#34;/{Version}/runtime/invocation/{RequestId}/response&#34;, OnResponse);
    });
}
</code></pre><p>The requests to pass to the function that are queued into the test server are routed through into a <code>Channel&lt;T></code> which provides a reader and writer that acts as a producer-consumer pair. Enqueueing a message places it into the <code>ChannelWriter&lt;T></code>, while the message pump consumes the <code>ChannelReader&lt;T></code>. You can read more about .NET&rsquo;s Channels in <a href=https://www.stevejgordon.co.uk/an-introduction-to-system-threading-channels title="An Introduction to System.Threading.Channels">this post</a> by fellow Microsoft MVP <a href=https://twitter.com/stevejgordon title="Steve Gordon on Twitter">Steve Gordon</a>.</p><p>Once I was happy with the basic concept and had it working with my Alexa skill&rsquo;s codebase, I started the process to make it its own open source repository and to publish it as a NuGet package. Once I&rsquo;d shipped <a href=https://github.com/martincostello/lambda-test-server/releases/tag/v0.1.0 title="AWS Lambda Test Server v0.1.0">version 0.1.0</a> I then just needed to circle back around to my skill and <a href=https://github.com/martincostello/alexa-london-travel/pull/140 title="Use AwsLambdaTestServer NuGet package">delete the proof-of-concept and consume the library instead</a>.</p><h2 id=improvements>Improvements</h2><p>In the course of implementing the first version there were a few bits I wasn&rsquo;t entirely happy with.</p><p>The first was that I needed to use reflection to pass the <code>HttpClient</code> for the test server into <code>LambdaBootstrap</code> to get it wired-up. Not the end of the world, but not as neat as it could be.</p><p>The second was that the Lambda runtime loop, depending on timing, would always wait for at least one more new message to process before terminating, even if your test was completed and didn&rsquo;t need to queue anything new. I worked around this by having the test server deliver a &ldquo;fake&rdquo; message with empty content to &ldquo;break&rdquo; the loop.</p><p>These seemed like simple enough things to alter, and with the AWS SDK for Lambda being open source on GitHub, I <a href=https://github.com/aws/aws-lambda-dotnet/pull/540 title="Suggested changes for LambdaBootstrap testability">submitted a Pull Request</a> to refactor things a bit to allow the <code>HttpClient</code> to be injected and to have the message loop observe a thrown <code>OperationCanceledException</code> if the cancellation token for the loop was signalled.</p><p><a href=https://twitter.com/stuartblang title="Stuart Lang on Twitter">Stuart Lang</a>, an ex-colleague of mine I&rsquo;d been discussing the test server with, <a href=https://twitter.com/stuartblang/status/1190949491781914624>reached out</a> to AWS&rsquo; <a href=https://twitter.com/socketnorm title="Norm Johanson on Twitter">Norm Johanson</a> to have him look at the PR. Just under three days later the PR had been merged and a new version of the library pushed to NuGet.org!</p><blockquote class=twitter-tweet align=center><p lang=en dir=ltr>Closing the loop on this the PR has been released as part of version 1.1.0 of Amazon.Lambda.RuntimeSupport <a href=https://t.co/qJhP9B2hoB>pic.twitter.com/qJhP9B2hoB</a></p>&mdash; Norm Johanson (@socketnorm) <a href="https://twitter.com/socketnorm/status/1191966966183018496?ref_src=twsrc%5Etfw">November 6, 2019</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>With the changes made available, all that was left was to <a href=https://github.com/martincostello/lambda-test-server/pull/17 title="Remove workarounds for Amazon.Lambda.RuntimeSupport">remove the workarounds</a>, publish an updated version of <em>Lambda Test Server</em> and <a href=https://github.com/martincostello/alexa-london-travel/pull/152 title="Update lambda-test-server">update my Alexa skill&rsquo;s tests to use it</a>.</p><h2 id=conclusion>Conclusion</h2><p>Using <em>Lambda Test Server</em> in my Alexa skill, as well as the EC2 to Lambda migration at work, has allowed me to write a small number of acceptance-style integration tests for some Lambda functions while also providing high code coverage (>80%) and being able to target .NET Core 3.0 without the native Lambda runtime support.</p><p>At the same time it&rsquo;s also taught me some things about how the AWS Lambda runtime works internally, which I&rsquo;ve found interesting, as well as some experience coding with channels and the lower-level endpoint routing in ASP.NET Core 3.0 without the weight of using MVC controllers.</p><p>With just some small refactoring of your function entrypoint to accept an <code>HttpClient</code> and <code>CancellationToken</code>, you can really boost the amount of code you can quickly test locally before committing your code to Continuous Integration and deploying it to your AWS account.</p><p>I hope you find it useful in your own .NET Core Lambda functions!</p><hr><p><div class=row><div class=col-lg-6><a href="https://bsky.app/intent/compose?text=Integration+testing+AWS+Lambda+C%23+Functions+with+Lambda+Test+Server+by+%40martincostello.com+-+https%3A%2F%2Fblog.martincostello.com%2Fintegration-testing-aws-lambda-c%2523-functions-with-lambda-test-server%2F" target=_blank rel=noopener class="btn btn-info btn-sm" title="Share on Bluesky">Share on Bluesky
<span class="fa-brands fa-bluesky" aria-hidden=true></span></a></div></div></p><hr><footer><p><div class=row><div class="d-none d-md-block col">&copy; Martin Costello 2014-2025 |
Built from <a href=https://github.com/martincostello/blog/commit/4116b929c2636f9c037d8c2a6c02e0a2140cd9fc rel=noopener title="View commit 4116b929c2636f9c037d8c2a6c02e0a2140cd9fc on GitHub">4116b92</a> on <a href=https://github.com/martincostello/blog/tree/copilot/fix-244 rel=noopener title="View branch copilot/fix-244 on GitHub">copilot/fix-244</a></div><div class=d-md-none><div class=col>&copy; Martin Costello 2014-2025</div></div></div></p></footer></main><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/flatly/bootstrap.min.css integrity="sha512-O+EA0Agf5+pB8u7CtnIAYq/BKyFPMT8c0DFjmqLyfIJJ9Fm8GBohV/0H0TFaZ96+jieN8zUVY4IkSBso9z6hpg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer async><link rel=stylesheet href=/styles/site.css><script src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src="https://www.googletagmanager.com/gtag/js?id=G-XJFV74HRL6" async></script><script>window.hugoSiteParams={render_analytics:!0,analytics_id:"G-XJFV74HRL6"}</script><script src=/scripts/site.js defer></script></body></html>